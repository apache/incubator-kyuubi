<!--
 - Licensed to the Apache Software Foundation (ASF) under one or more
 - contributor license agreements.  See the NOTICE file distributed with
 - this work for additional information regarding copyright ownership.
 - The ASF licenses this file to You under the Apache License, Version 2.0
 - (the "License"); you may not use this file except in compliance with
 - the License.  You may obtain a copy of the License at
 -
 -   http://www.apache.org/licenses/LICENSE-2.0
 -
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS,
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 - See the License for the specific language governing permissions and
 - limitations under the License.
 -->

<!-- DO NOT MODIFY THIS FILE DIRECTLY, IT IS AUTO GENERATED BY [org.apache.kyuubi.engine.spark.udf.KyuubiUDFRegistrySuite] -->

<div align=center>

![](../imgs/kyuubi_logo.png)

</div>

# Auxiliary SQL extension for Spark SQL

Kyuubi provides SQL extension out of box. Due to the version compatibility with Apache Spark, currently we only support Apache Spark branch-3.1 (i.e 3.1.1 and 3.1.2).
And don't worry, Kyuubi will support the new Apache Spark version in future. Thanks to the adaptive query execution framework (AQE), Kyuubi can do these optimization.

## What feature does Kyuubi SQL extension provide
- merging small files automatically
  
  Small files is a long time issue with Apache Spark. Kyuubi can merge small files by adding an extra shuffle.
  Currently, Kyuubi supports handle small files with datasource table and hive table, and also Kyuubi support optimize dynamic partition insertion.
  For example, a common write query `INSERT INTO TABLE $table1 SELECT * FROM $table2`, Kyuubi will introduce an extra shuffle before write and then the small files will go away.


- insert shuffle node before Join to make AQE OptimizeSkewedJoin work

  In current implementation, Apache Spark can only optimize skewed join by the standard join which means a join must have two sort and shuffle node.
  However, in complex scenario this assuming will be broken easily. Kyuubi can guarantee the join is standard by adding an extra shuffle node before join.
  So that, OptimizeSkewedJoin can work better.


- stage level config isolation in AQE

  As we know, `spark.sql.adaptive.advisoryPartitionSizeInBytes` is a key config in Apache Spark AQE.
  It controls how big data size per-task should handle during shuffle, so we always use a 64MB or a smaller value to make parallelism enough.
  However, in general, we expect a file is big enough like 256MB or 512MB. Kyuubi can make the config isolation to solve the conflict so that
  we can make staging partition data size small and last partition data size big.


## How to use Kyuubi SQL extension

1. you need to choose Apache Spark branch-3.1 or higher version with Kyuubi binary tgz.
2. if you want to compile Kyuubi by yourself, the maven opt should add `-Pkyuubi-extension-spark-3-1`
3. move the jar(`kyuubi-extension-spark-*.jar`) which is in `$KYUUBI_HOME/extension` into `$SPARK_HOME/jars`
4. add a config into `spark-defaults.conf`, `spark.sql.extensions=org.apache.kyuubi.sql.KyuubiSparkSQLExtension`

Now, you can enjoy the Kyuubi SQL Extension, and also Kyuubi provides some configs to make these feature easy to use.

Name | Default Value | Description | Since
--- | --- | --- | ---
spark.sql.optimizer.insertRepartitionBeforeWrite.enabled | true | Add repartition node at the top of query plan. An approach of merging small files. | 1.2.0
spark.sql.optimizer.insertRepartitionNum | none | The partition number if `spark.sql.optimizer.insertRepartitionBeforeWrite.enabled` is enabled. If AQE is disabled, the default value is `spark.sql.shuffle.partitions`. If AQE is enabled, the default value is none that means depend on AQE. | 1.2.0
spark.sql.optimizer.dynamicPartitionInsertionRepartitionNum | 100 | The partition number of each dynamic partition if `spark.sql.optimizer.insertRepartitionBeforeWrite.enabled` is enabled. We will repartition by dynamic partition columns to reduce the small file but that can cause data skew. This config is to extend the partition of dynamic partition column to avoid skew but may generate some small files. | 1.2.0
spark.sql.optimizer.forceShuffleBeforeJoin.enabled | false | Ensure shuffle node exists before shuffled join (shj and smj) to make AQE `OptimizeSkewedJoin` works (complex scenario join, multi table join). | 1.2.0
spark.sql.optimizer.finalStageConfigIsolation.enabled | false | If true, the final stage support use different config with previous stage. The prefix of final stage config key should be `spark.sql.finalStage.`. For example, the raw spark config: `spark.sql.adaptive.advisoryPartitionSizeInBytes`, then the final stage config should be: `spark.sql.finalStage.adaptive.advisoryPartitionSizeInBytes`. | 1.2.0

姓名 |默认值 |说明 |自从
--- | --- | --- | ---
spark.sql.optimizer.insertRepartitionBeforeWrite.enabled |真实|在查询计划的顶部添加重新分区节点。一种合并小文件的方法。 | 1.2.0
spark.sql.optimizer.insertRepartitionNum |无 |如果启用了 `spark.sql.optimizer.insertRepartitionBeforeWrite.enabled`，则为分区号。如果 AQE 被禁用，默认值为 `spark.sql.shuffle.partitions`。如果启用了 AQE，则默认值为 none，表示依赖于 AQE。 | 1.2.0
spark.sql.optimizer.dynamicPartitionInsertionRepartitionNum | 100 |如果启用了 `spark.sql.optimizer.insertRepartitionBeforeWrite.enabled`，则每个动态分区的分区号。我们将通过动态分区列重新分区以减少小文件，但这会导致数据倾斜。此配置是为了扩展动态分区列的分区以避免倾斜但可能会生成一些小文件。 | 1.2.0
spark.sql.optimizer.forceShuffleBeforeJoin.enabled |假|确保 shuffle 节点在 shuffled join（shj 和 smj）之前存在，以使 AQE `OptimizeSkewedJoin` 工作（复杂场景连接，多表连接）。 | 1.2.0
spark.sql.optimizer.finalStageConfigIsolation.enabled |假|如果为 true，则最后阶段支持使用与前一阶段不同的配置。最后阶段配置键的前缀应该是`spark.sql.finalStage.`。例如，原始 spark 配置：`spark.sql.adaptive.advisoryPartitionSizeInBytes`，那么最终阶段配置应该是：`spark.sql.finalStage.adaptive.advisoryPartitionSizeInBytes`。 | 1.2.0